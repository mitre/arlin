<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Explainability Tutorial &mdash; ARLIN - Assured Reinforcement Learning Model Interrogation latest documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=c6e86fd7"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Contributing" href="../contributing.html" />
    <link rel="prev" title="Adversarial Tutorial" href="adversarial.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            ARLIN - Assured Reinforcement Learning Model Interrogation
          </a>
              <div class="version">
                1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="adversarial.html">Adversarial Tutorial</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Explainability Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#analysis-of-initial-clusters">Analysis of Initial Clusters</a></li>
<li class="toctree-l2"><a class="reference internal" href="#analysis-of-intermediate-clusters">Analysis of Intermediate Clusters</a></li>
<li class="toctree-l2"><a class="reference internal" href="#analysis-of-terminal-clusters">Analysis of Terminal Clusters</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../autoapi/index.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">ARLIN - Assured Reinforcement Learning Model Interrogation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">&lt;no title&gt;</a></li>
      <li class="breadcrumb-item active">Explainability Tutorial</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/tutorials/explainable.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="explainability-tutorial">
<h1>Explainability Tutorial<a class="headerlink" href="#explainability-tutorial" title="Link to this heading"></a></h1>
<p>ARLIN can be used from an explainability standpoint to give insights into why a
reinforcement learning model behaves from a holistic point of view as well as help
identify potential vulnerabilities within a trained model prior to deployment.</p>
<p align="center">
  <img src="../_static/explainable/workflow.png" />
  <b>Figure 1.</b> Example workflow of how ARLIN can be used for explainability purposes.
</p>
<p>Below is a simple example of ARLIN being used for explainability analysis.</p>
<p><em>Note: Not all available methods are shown.</em></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">gymnasium</span> <span class="k">as</span> <span class="nn">gym</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">arlin.dataset.loaders</span> <span class="k">as</span> <span class="nn">loaders</span>
<span class="kn">from</span> <span class="nn">arlin.dataset</span> <span class="kn">import</span> <span class="n">XRLDataset</span>
<span class="kn">from</span> <span class="nn">arlin.dataset.collectors</span> <span class="kn">import</span> <span class="n">SB3PPODataCollector</span><span class="p">,</span> <span class="n">SB3PPODatapoint</span>

<span class="kn">from</span> <span class="nn">arlin.generation</span> <span class="kn">import</span> <span class="n">generate_clusters</span><span class="p">,</span> <span class="n">generate_embeddings</span>
<span class="kn">import</span> <span class="nn">arlin.analysis.visualization</span> <span class="k">as</span> <span class="nn">viz</span>
<span class="kn">from</span> <span class="nn">arlin.analysis</span> <span class="kn">import</span> <span class="n">ClusterAnalyzer</span><span class="p">,</span> <span class="n">LatentAnalyzer</span>
<span class="kn">from</span> <span class="nn">arlin.samdp</span> <span class="kn">import</span> <span class="n">SAMDP</span>
<span class="kn">import</span> <span class="nn">arlin.utils.saving_loading</span> <span class="k">as</span> <span class="nn">sl_utils</span>

<span class="c1"># Create environment</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s2">&quot;LunarLander-v2&quot;</span><span class="p">)</span>

<span class="c1"># Load the SB3 model from Huggingface</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">loaders</span><span class="o">.</span><span class="n">load_hf_sb_model</span><span class="p">(</span><span class="n">repo_id</span><span class="o">=</span><span class="s2">&quot;sb3/ppo-LunarLander-v2&quot;</span><span class="p">,</span>
                                  <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;ppo-LunarLander-v2.zip&quot;</span><span class="p">,</span>
                                  <span class="n">algo_str</span><span class="o">=</span><span class="s2">&quot;ppo&quot;</span><span class="p">)</span>

<span class="c1"># Create the datapoint collector for SB3 PPO Datapoints with the model&#39;s policy</span>
<span class="n">collector</span> <span class="o">=</span> <span class="n">SB3PPODataCollector</span><span class="p">(</span><span class="n">datapoint_cls</span><span class="o">=</span><span class="n">SB3PPODatapoint</span><span class="p">,</span>
                                <span class="n">policy</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">policy</span><span class="p">)</span>

<span class="c1"># Instantiate the XRL Dataset</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">XRLDataset</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">collector</span><span class="o">=</span><span class="n">collector</span><span class="p">)</span>

<span class="c1"># Fill the dataset with 50k datapoints and add in additional analysis datapoints</span>
<span class="n">dataset</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">num_datapoints</span><span class="o">=</span><span class="mi">50000</span><span class="p">)</span>

<span class="n">embeddings</span> <span class="o">=</span> <span class="n">generate_embeddings</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
                                  <span class="n">activation_key</span><span class="o">=</span><span class="s1">&#39;latent_actors&#39;</span><span class="p">,</span>
                                  <span class="n">perplexity</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                                  <span class="n">n_train_iter</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span>
                                  <span class="n">output_dim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                  <span class="n">seed</span><span class="o">=</span><span class="mi">12345</span><span class="p">)</span>

<span class="n">clusters</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">generate_clusters</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
                                      <span class="n">num_clusters</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="c1"># Create a grapher to generate data used for analysis.</span>
<span class="n">grapher</span> <span class="o">=</span> <span class="n">LatentAnalyzer</span><span class="p">(</span><span class="n">embeddings</span><span class="p">,</span> <span class="n">dataset</span><span class="p">)</span>

<span class="c1"># Generate latent analysis data for visualization</span>
<span class="n">ep_prog_data</span> <span class="o">=</span> <span class="n">grapher</span><span class="o">.</span><span class="n">episode_prog_graph_data</span><span class="p">()</span>
<span class="n">conf_data</span> <span class="o">=</span> <span class="n">grapher</span><span class="o">.</span><span class="n">confidence_data</span><span class="p">()</span>
<span class="n">decision_boundaries</span> <span class="o">=</span> <span class="n">grapher</span><span class="o">.</span><span class="n">decision_boundary_graph_data</span><span class="p">()</span>

<span class="c1"># Graph multiple analytics as subplots in one plot</span>
<span class="n">viz</span><span class="o">.</span><span class="n">graph_multiple_data</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="s1">&#39;./latent_analysis.png&#39;</span><span class="p">,</span>
                        <span class="n">figure_title</span><span class="o">=</span><span class="s1">&#39;Latent Analytics&#39;</span><span class="p">,</span>
                        <span class="n">graph_datas</span><span class="o">=</span><span class="p">[</span><span class="n">ep_prog_data</span><span class="p">,</span>
                                      <span class="n">conf_data</span><span class="p">,</span>
                                      <span class="n">decision_boundaries</span><span class="p">])</span>

<span class="c1"># Generate cluster analysis data for visualization</span>
<span class="n">cluster_conf</span> <span class="o">=</span> <span class="n">grapher</span><span class="o">.</span><span class="n">cluster_confidence</span><span class="p">()</span>
<span class="n">cluster_rewards</span> <span class="o">=</span> <span class="n">grapher</span><span class="o">.</span><span class="n">cluster_rewards</span><span class="p">()</span>
<span class="n">cluster_values</span> <span class="o">=</span> <span class="n">grapher</span><span class="o">.</span><span class="n">cluster_values</span><span class="p">()</span>

<span class="c1"># Graph multiple subplots in one plot</span>
<span class="n">viz</span><span class="o">.</span><span class="n">graph_multiple_data</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="s1">&#39;./cluster_analysis.png&#39;</span><span class="p">,</span>
                        <span class="n">figure_title</span><span class="o">=</span><span class="s1">&#39;Cluster Analytics&#39;</span><span class="p">,</span>
                        <span class="n">graph_datas</span><span class="o">=</span><span class="p">[</span><span class="n">cluster_conf</span><span class="p">,</span>
                                      <span class="n">cluster_values</span><span class="p">,</span>
                                      <span class="n">cluster_rewards</span><span class="p">])</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">]:</span>
  <span class="n">grapher</span><span class="o">.</span><span class="n">cluster_state_analysis</span><span class="p">(</span><span class="n">i</span><span class="p">,</span>
                                  <span class="n">env</span><span class="p">,</span>
                                  <span class="sa">f</span><span class="s1">&#39;./state_analysis_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">.png&#39;</span><span class="p">)</span>

<span class="n">simplified_graph</span> <span class="o">=</span> <span class="n">samdp</span><span class="o">.</span><span class="n">save_simplified_graph</span><span class="p">(</span><span class="s1">&#39;./simplified_samdp.png&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p align="center">
  <img src="../_static/explainable/latent_analytics.png" />
  <b>Figure 2.</b> Analysis of the XRLDataset latent space.
</p>
<p>With the above latent analysis (Figure 2), we can gain information about the latent space
of our policy, including episode progression (how the agent moves through the latent space
over the course of an episode), policy confidence (how certain the policy is that it is
taking thecorrect action at a given point in the latent space), and decision boundaries
(which actions are taken at a given point in the latent space).</p>
<p align="center">
  <img src="../_static/explainable/cluster_analytics.png" />
  <b>Figure 3.</b> Analysis of the XRLDatset clusters.
</p>
<p>The above cluster analysis (Figure 3) gives information about the different clusters
within the policy’s latent space that we use to generate the SAMDP. The cluster confidence
takes the average confidence of each state within each cluster, cluster value gives the
average value (or expected return) at every state in each cluster, and cluster reward
gives the average reward from each state in each cluster. With this information, we can
gain a few interesting insights about our policy.</p>
<section id="analysis-of-initial-clusters">
<h2>Analysis of Initial Clusters<a class="headerlink" href="#analysis-of-initial-clusters" title="Link to this heading"></a></h2>
<p>We can see that we have 2 initial clusters: 20 and 21. Cluster 20 has a high confidence
and a high value, while Cluster 21 has a lower confidence and value. This tells us that
starting states within Cluster 21 are seen as “less profitable” than starting states in
Cluster 20. For mission success, the policy would prefer to begin in a state from Cluster
20 - starting states from Cluster 21 may be more likely to end in mission failure.</p>
</section>
<section id="analysis-of-intermediate-clusters">
<h2>Analysis of Intermediate Clusters<a class="headerlink" href="#analysis-of-intermediate-clusters" title="Link to this heading"></a></h2>
<p>The intermediate clusters are Clusters 0 - 19. Most do not give much information, though
we can identify when in the episode progression these clusters take place by analyzing the
cluster values - earlier stage clusters will have a higher value, while later stage
clusters will have a lower value.</p>
<p>Using the cluster reward analysis, we can identify Cluster 9 as an interesting cluster.
Cluster 9 has a negative reward but a decent confidence and a low value. This tells us
that Cluster 9 is likely a late-stage corrective maneuver. The policy knows it will get a
negative reward but has high confidence in the action it needs to take, pointing towards
a movement the policy feels is necessary for mission success.</p>
</section>
<section id="analysis-of-terminal-clusters">
<h2>Analysis of Terminal Clusters<a class="headerlink" href="#analysis-of-terminal-clusters" title="Link to this heading"></a></h2>
<p>We have 4 potential terminal clusters: Clusters 22 - 25. Two clusters are successful
missions - Clusters 22 and 25. Both have similar statistics, but Cluster 25 has a lower
variance, typically pointing to a smaller cluster. This means Cluster 25 is likely a
rarer success that Cluster 22. Two clusters are failure missions - Clusters 23 and 24.
Cluster 23 has a low expected return and a low reward - this tells us this is likely an
expected failure since the model is expecting to get a low result and gets a low result.
However, Cluster 24 has a higher value and low reward which means the model was expecting
to get a higher reward and actually got a lower one. This tells us Cluster 24 represents
an unexpected failure.</p>
<p align="center">
  <img src="../_static/explainable/state_analysis.png" />
  <b>Figure 4.</b> State analysis of Clusters 9, 23, and 24 (left to right).
</p>
<p>Figure 4 shows screenshots of the environment from within 3 separate clusters: Clusters 9,
23, and 24. These screenshots confirm our analysis from above proving that Cluster 9 is
a late-stage corrective maneuver (moving towards middle of flags), Cluster 23 is an
expected failure (hard landing), and Cluster 24 is an unexpected failure (moving out of
bounds).</p>
<p align="center">
  <img src="../_static/explainable/samdp_simplified.png" />
  <b>Figure 5.</b> SAMDP of the policy used to create the XRLDataset.
</p>
<p>The above analysis (Figure 5) shows us a holistic view of the policy through an SAMDP
(semi-aggregated Markov decision process). The initial states show on the left of the
visualization while the terminal states are on the right. This graphic is the simplified
SAMDP, meaning the actions to bring the policy from Cluster A to Cluster B are not shown
and we instead only focus on the movement between clusters.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="adversarial.html" class="btn btn-neutral float-left" title="Adversarial Tutorial" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../contributing.html" class="btn btn-neutral float-right" title="Contributing" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, MITRE.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>